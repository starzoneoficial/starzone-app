name: Build Electron

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Opcional: Concurrencia solo para agrupar logs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    
    strategy:
      fail-fast: false  # ⬅️ ¡IMPORTANTE! Un OS falla no cancela los demás
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Debug OS info
      run: |
        echo "OS: ${{ runner.os }}"
        echo "Runner: ${{ runner.name }}"
        echo "Arch: $(uname -m)"
    
    - name: Install dependencies
      run: |
        npm ci --no-audit --prefer-offline
        
        # Verificar si electron-builder está instalado
        if [ ! -f "node_modules/.bin/electron-builder" ]; then
          npm install electron-builder --save-dev --no-audit
        fi
    
    - name: Build Electron
      run: |
        # Determinar sistema operativo para electron-builder
        case "${{ runner.os }}" in
          "Linux")
            TARGET="linux"
            ;;
          "Windows")
            TARGET="win"
            ;;
          "macOS")
            TARGET="mac"
            ;;
          *)
            TARGET=""
            ;;
        esac
        
        if [ -n "$TARGET" ]; then
          echo "Building for $TARGET"
          npm run build:$TARGET --if-present || \
          npm run make --if-present || \
          npm run dist --if-present || \
          npx electron-builder --$TARGET
        else
          echo "Running default build"
          npm run build --if-present || npm run make --if-present
        fi
      
      env:
        CI: true
        # Variables para CI
        ELECTRON_SKIP_NOTARIZE: true
        CSC_IDENTITY_AUTO_DISCOVERY: false
    
    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: electron-${{ runner.os }}
        path: |
          dist/
          release/
          out/
          build/
          *.exe
          *.dmg
          *.AppImage
          *.deb
          *.rpm
        if-no-files-found: ignore  # ⬅️ Cambiado a ignore
        retention-days: 7
